name: Discord Notification

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect content changes
        id: changes
        run: |
          WIKI_CHANGES=$(git diff --name-status HEAD~1 -- 'content/wiki/**/*.mdx' 2>/dev/null || echo "")
          BLOG_CHANGES=$(git diff --name-status HEAD~1 -- 'content/blog/articles/*.mdx' 2>/dev/null || echo "")

          echo "wiki_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$WIKI_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "blog_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$BLOG_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$WIKI_CHANGES" ] || [ -n "$BLOG_CHANGES" ]; then
            echo "has_content_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_content_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: steps.changes.outputs.has_content_changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WIKI_CHANGES: ${{ steps.changes.outputs.wiki_changes }}
          BLOG_CHANGES: ${{ steps.changes.outputs.blog_changes }}
        run: |
          BASE_URL="https://tontonsflingueurs.github.io"
          NEWLINE=$'\n'

          WIKI_NEW=""
          WIKI_MOD=""
          BLOG_NEW=""
          BLOG_MOD=""

          # Traitement Wiki
          if [ -n "$WIKI_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              [ "$status" = "D" ] && continue
              if [[ "$status" == R* ]]; then
                filepath=$(echo "$filepath" | cut -f2)
              fi
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/')
              [ -z "$TITLE" ] && continue
              SLUG=$(echo "$filepath" | sed 's|content/wiki/||;s|\.mdx$||;s|/index$||')
              [ -z "$SLUG" ] && URL="$BASE_URL/wiki" || URL="$BASE_URL/wiki/$SLUG"

              if [ "$status" = "A" ] || [[ "$status" == R* ]]; then
                WIKI_NEW="${WIKI_NEW}â€¢ [${TITLE}](<${URL}>)${NEWLINE}"
              else
                WIKI_MOD="${WIKI_MOD}â€¢ [${TITLE}](<${URL}>)${NEWLINE}"
              fi
            done <<< "$WIKI_CHANGES"
          fi

          # Traitement Blog
          if [ -n "$BLOG_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              [ "$status" = "D" ] && continue
              if [[ "$status" == R* ]]; then
                filepath=$(echo "$filepath" | cut -f2)
              fi
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/')
              [ -z "$TITLE" ] && continue
              SLUG=$(echo "$filepath" | sed 's|content/blog/articles/||;s|\.mdx$||')
              URL="$BASE_URL/blog/$SLUG"

              if [ "$status" = "A" ] || [[ "$status" == R* ]]; then
                BLOG_NEW="${BLOG_NEW}â€¢ [${TITLE}](<${URL}>)${NEWLINE}"
              else
                BLOG_MOD="${BLOG_MOD}â€¢ [${TITLE}](<${URL}>)${NEWLINE}"
              fi
            done <<< "$BLOG_CHANGES"
          fi

          # Construction du message
          MESSAGE="ðŸš€ **Mise Ã  jour du site !** @everyone${NEWLINE}${NEWLINE}"

          # Section Nouveau
          if [ -n "$WIKI_NEW" ] || [ -n "$BLOG_NEW" ]; then
            MESSAGE="${MESSAGE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NEWLINE}ðŸ“— **NOUVEAU**${NEWLINE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NEWLINE}${NEWLINE}"
            if [ -n "$WIKI_NEW" ]; then
              MESSAGE="${MESSAGE}**Wiki**${NEWLINE}${WIKI_NEW}"
            fi
            if [ -n "$BLOG_NEW" ]; then
              MESSAGE="${MESSAGE}**Blog**${NEWLINE}${BLOG_NEW}"
            fi
            # Espace aprÃ¨s la section Nouveau
            MESSAGE="${MESSAGE}${NEWLINE}"
          fi

          # Section ModifiÃ©
          if [ -n "$WIKI_MOD" ] || [ -n "$BLOG_MOD" ]; then
            MESSAGE="${MESSAGE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NEWLINE}ðŸ“ **MODIFIÃ‰**${NEWLINE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NEWLINE}${NEWLINE}"
            if [ -n "$WIKI_MOD" ]; then
              MESSAGE="${MESSAGE}**Wiki**${NEWLINE}${WIKI_MOD}"
            fi
            if [ -n "$BLOG_MOD" ]; then
              MESSAGE="${MESSAGE}**Blog**${NEWLINE}${BLOG_MOD}"
            fi
          fi

          # Espace avant la banniÃ¨re (caractÃ¨re invisible pour que Discord garde la ligne)
          MESSAGE="${MESSAGE}"

          # TÃ©lÃ©charger la banniÃ¨re
          curl -sL -o banniere.webp "$BASE_URL/wiki/banniere.webp"

          # CrÃ©er le payload JSON
          PAYLOAD=$(jq -n \
            --arg content "$MESSAGE" \
            '{
              "content": $content,
              "allowed_mentions": {
                "parse": ["everyone"]
              }
            }')

          # Envoyer avec l'image en attachment
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -F "payload_json=$PAYLOAD" \
            -F "file=@banniere.webp"
