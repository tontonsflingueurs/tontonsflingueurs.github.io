name: Discord Notification

on:
  # Se declenche apres le deploy GitHub Pages
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect content changes
        id: changes
        run: |
          WIKI_CHANGES=$(git diff --name-status HEAD~1 -- 'content/wiki/**/*.mdx' 2>/dev/null || echo "")
          BLOG_CHANGES=$(git diff --name-status HEAD~1 -- 'content/blog/articles/*.mdx' 2>/dev/null || echo "")

          echo "wiki_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$WIKI_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "blog_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$BLOG_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$WIKI_CHANGES" ] || [ -n "$BLOG_CHANGES" ]; then
            echo "has_content_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_content_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: steps.changes.outputs.has_content_changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WIKI_CHANGES: ${{ steps.changes.outputs.wiki_changes }}
          BLOG_CHANGES: ${{ steps.changes.outputs.blog_changes }}
        run: |
          BASE_URL="https://tontonsflingueurs.github.io"
          NEWLINE=$'\n'

          # Variables pour grouper
          WIKI_NEW=""
          WIKI_MOD=""
          BLOG_NEW=""
          BLOG_MOD=""

          # Flag pour savoir quelle image afficher
          HAS_WIKI=false
          HAS_BLOG=false

          # Traitement des changements Wiki
          if [ -n "$WIKI_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              [ "$status" = "D" ] && continue
              if [[ "$status" == R* ]]; then
                filepath=$(echo "$filepath" | cut -f2)
              fi
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/')
              [ -z "$TITLE" ] && continue
              SLUG=$(echo "$filepath" | sed 's|content/wiki/||;s|\.mdx$||;s|/index$||')
              [ -z "$SLUG" ] && URL="$BASE_URL/wiki" || URL="$BASE_URL/wiki/$SLUG"
              HAS_WIKI=true

              if [ "$status" = "A" ] || [[ "$status" == R* ]]; then
                WIKI_NEW="${WIKI_NEW}> ğŸ“„ [${TITLE}](${URL})${NEWLINE}"
              else
                WIKI_MOD="${WIKI_MOD}> ğŸ“„ [${TITLE}](${URL})${NEWLINE}"
              fi
            done <<< "$WIKI_CHANGES"
          fi

          # Traitement des changements Blog
          if [ -n "$BLOG_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              [ "$status" = "D" ] && continue
              if [[ "$status" == R* ]]; then
                filepath=$(echo "$filepath" | cut -f2)
              fi
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/')
              [ -z "$TITLE" ] && continue
              SLUG=$(echo "$filepath" | sed 's|content/blog/articles/||;s|\.mdx$||')
              URL="$BASE_URL/blog/$SLUG"
              HAS_BLOG=true

              if [ "$status" = "A" ] || [[ "$status" == R* ]]; then
                BLOG_NEW="${BLOG_NEW}> ğŸ“ [${TITLE}](${URL})${NEWLINE}"
              else
                BLOG_MOD="${BLOG_MOD}> ğŸ“ [${TITLE}](${URL})${NEWLINE}"
              fi
            done <<< "$BLOG_CHANGES"
          fi

          # Choisir l'image (prioritÃ© au blog si prÃ©sent, sinon wiki)
          if [ "$HAS_BLOG" = true ]; then
            IMAGE_URL="$BASE_URL/blog/default.webp"
          else
            IMAGE_URL="$BASE_URL/wiki/banniere.webp"
          fi

          # Construction de la description avec sections
          DESCRIPTION=""

          # Section Nouveau
          if [ -n "$WIKI_NEW" ] || [ -n "$BLOG_NEW" ]; then
            DESCRIPTION="${DESCRIPTION}## ğŸ†• Nouveau${NEWLINE}${NEWLINE}"
            if [ -n "$WIKI_NEW" ]; then
              DESCRIPTION="${DESCRIPTION}**ğŸ“š Wiki**${NEWLINE}${WIKI_NEW}${NEWLINE}"
            fi
            if [ -n "$BLOG_NEW" ]; then
              DESCRIPTION="${DESCRIPTION}**ğŸ“° Blog**${NEWLINE}${BLOG_NEW}${NEWLINE}"
            fi
          fi

          # SÃ©parateur si les deux sections existent
          if { [ -n "$WIKI_NEW" ] || [ -n "$BLOG_NEW" ]; } && { [ -n "$WIKI_MOD" ] || [ -n "$BLOG_MOD" ]; }; then
            DESCRIPTION="${DESCRIPTION}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NEWLINE}${NEWLINE}"
          fi

          # Section ModifiÃ©
          if [ -n "$WIKI_MOD" ] || [ -n "$BLOG_MOD" ]; then
            DESCRIPTION="${DESCRIPTION}## âœï¸ ModifiÃ©${NEWLINE}${NEWLINE}"
            if [ -n "$WIKI_MOD" ]; then
              DESCRIPTION="${DESCRIPTION}**ğŸ“š Wiki**${NEWLINE}${WIKI_MOD}${NEWLINE}"
            fi
            if [ -n "$BLOG_MOD" ]; then
              DESCRIPTION="${DESCRIPTION}**ğŸ“° Blog**${NEWLINE}${BLOG_MOD}${NEWLINE}"
            fi
          fi

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Payload avec un seul embed bien formatÃ©
          PAYLOAD=$(jq -n \
            --arg desc "$DESCRIPTION" \
            --arg img "$IMAGE_URL" \
            --arg ts "$TIMESTAMP" \
            --arg url "$BASE_URL" \
            '{
              "content": "@everyone",
              "allowed_mentions": {
                "parse": ["everyone"]
              },
              "embeds": [
                {
                  "title": "ğŸš€ Mise Ã  jour du site !",
                  "url": $url,
                  "description": $desc,
                  "color": 5793266,
                  "image": {
                    "url": $img
                  },
                  "timestamp": $ts
                }
              ]
            }')

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
