name: Discord Notification

on:
  # Se declenche apres le deploy GitHub Pages
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect content changes
        id: changes
        run: |
          WIKI_CHANGES=$(git diff --name-status HEAD~1 -- 'content/wiki/**/*.mdx' 2>/dev/null || echo "")
          BLOG_CHANGES=$(git diff --name-status HEAD~1 -- 'content/blog/articles/*.mdx' 2>/dev/null || echo "")

          echo "wiki_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$WIKI_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "blog_changes<<EOF" >> $GITHUB_OUTPUT
          echo "$BLOG_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$WIKI_CHANGES" ] || [ -n "$BLOG_CHANGES" ]; then
            echo "has_content_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_content_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: steps.changes.outputs.has_content_changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WIKI_CHANGES: ${{ steps.changes.outputs.wiki_changes }}
          BLOG_CHANGES: ${{ steps.changes.outputs.blog_changes }}
        run: |
          BASE_URL="https://tontonsflingueurs.github.io"
          NEWLINE=$'\n'

          # Variables pour grouper par action (nouveau/modifie) puis par type (wiki/blog)
          WIKI_NEW=""
          WIKI_MOD=""
          BLOG_NEW=""
          BLOG_MOD=""

          # Traitement des changements Wiki
          if [ -n "$WIKI_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/' || echo "$filepath")
              SLUG=$(echo "$filepath" | sed 's|content/wiki/||;s|\.mdx$||;s|/index$||')
              [ -z "$SLUG" ] && URL="$BASE_URL/wiki" || URL="$BASE_URL/wiki/$SLUG"
              if [ "$status" = "A" ]; then
                WIKI_NEW="${WIKI_NEW}â€¢ ${TITLE}${NEWLINE}${URL}${NEWLINE}"
              else
                WIKI_MOD="${WIKI_MOD}â€¢ ${TITLE}${NEWLINE}${URL}${NEWLINE}"
              fi
            done <<< "$WIKI_CHANGES"
          fi

          # Traitement des changements Blog
          if [ -n "$BLOG_CHANGES" ]; then
            while IFS=$'\t' read -r status filepath; do
              [ -z "$filepath" ] && continue
              TITLE=$(grep -m1 '^title:' "$filepath" 2>/dev/null | sed 's/title: *"\?\([^"]*\)"\?/\1/' || echo "$filepath")
              SLUG=$(echo "$filepath" | sed 's|content/blog/articles/||;s|\.mdx$||')
              URL="$BASE_URL/blog/$SLUG"
              if [ "$status" = "A" ]; then
                BLOG_NEW="${BLOG_NEW}â€¢ ${TITLE}${NEWLINE}${URL}${NEWLINE}"
              else
                BLOG_MOD="${BLOG_MOD}â€¢ ${TITLE}${NEWLINE}${URL}${NEWLINE}"
              fi
            done <<< "$BLOG_CHANGES"
          fi

          # Construction des embeds separes
          EMBEDS="[]"

          # Embed pour les modifications
          if [ -n "$WIKI_MOD" ] || [ -n "$BLOG_MOD" ]; then
            MOD_FIELDS="[]"
            if [ -n "$WIKI_MOD" ]; then
              MOD_FIELDS=$(echo "$MOD_FIELDS" | jq --arg name "ðŸ“š Wiki" --arg value "$WIKI_MOD" '. += [{"name": $name, "value": $value}]')
            fi
            if [ -n "$WIKI_MOD" ] && [ -n "$BLOG_MOD" ]; then
              MOD_FIELDS=$(echo "$MOD_FIELDS" | jq '. += [{"name": "\u200B", "value": "\u200B"}]')
            fi
            if [ -n "$BLOG_MOD" ]; then
              MOD_FIELDS=$(echo "$MOD_FIELDS" | jq --arg name "ðŸ“° Blog" --arg value "$BLOG_MOD" '. += [{"name": $name, "value": $value}]')
            fi
            EMBEDS=$(echo "$EMBEDS" | jq --argjson fields "$MOD_FIELDS" '. += [{"title": "âœï¸ ModifiÃ©", "color": 15105570, "fields": $fields}]')
          fi

          # Embed pour les nouveautes
          if [ -n "$WIKI_NEW" ] || [ -n "$BLOG_NEW" ]; then
            NEW_FIELDS="[]"
            if [ -n "$WIKI_NEW" ]; then
              NEW_FIELDS=$(echo "$NEW_FIELDS" | jq --arg name "ðŸ“š Wiki" --arg value "$WIKI_NEW" '. += [{"name": $name, "value": $value}]')
            fi
            if [ -n "$WIKI_NEW" ] && [ -n "$BLOG_NEW" ]; then
              NEW_FIELDS=$(echo "$NEW_FIELDS" | jq '. += [{"name": "\u200B", "value": "\u200B"}]')
            fi
            if [ -n "$BLOG_NEW" ]; then
              NEW_FIELDS=$(echo "$NEW_FIELDS" | jq --arg name "ðŸ“° Blog" --arg value "$BLOG_NEW" '. += [{"name": $name, "value": $value}]')
            fi
            EMBEDS=$(echo "$EMBEDS" | jq --argjson fields "$NEW_FIELDS" '. += [{"title": "ðŸ†• Nouveau", "color": 5763719, "fields": $fields}]')
          fi

          # Send Discord webhook avec @everyone
          PAYLOAD=$(jq -n \
            --argjson embeds "$EMBEDS" \
            '{
              "content": "@everyone **ðŸš€ Mise Ã  jour du site !**",
              "allowed_mentions": {
                "parse": ["everyone"]
              },
              "embeds": $embeds
            }')

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
